# Middleware

## Request ID

Middleware RequestID is a function to get identifier in a API request. Basically this will take the value
from `X-Request-ID` key in the request header.

### Implementation

```go
import (
    QoalaMiddleware "github.com/qoala-engineering/qoala-common/middleware"
)

func main() {
    // some code

    ....
    // initiate echo framework
    e := echo.New()

    // use requestID middleware
    e.Use(QoalaMiddleware.MiddlewareRequestID())
    ....

    // some code
}
```

## Auth Middleware

Auth Middleware can be used with your HTTP handlers to authenticate a Qoala JWT V1/V2 token or even a partner API key.
- A Qoala JWT V1 Token corresponds to Qoala App Tokens that's generated by user service.
- A Qoala JWT V2 Token corresponds to External Dashboard Tokens that's generated by user service.

The middleware requires an `AuthEndpoint` configured when constructing the middleware. 

When using **KeyAuth middleware** for authenticating users by the `x-api-key` header, the PartnerKeyEndpoint needs to be set, 
otherwise the middleware panics and results in build failures.

When using **JWTAuth middleware** for authenticating users by the Bearer token, the JWTKeyEndpoint needs to be set.



### Implementation


Following snippet allows you to implement route-based authentication. This middleware is executed after router processes the request and has full access to echo.Context API. Unauthorized response return Unauthorized status code 401 directly to the caller of the APIs and do not needed to be handled further by the user of the middleware.

**NOTE:** The middleware is written using net/http library and will work with any HTTP Router libraries such as gin, mux etc.

```go
import (
    QoalaMiddleware "github.com/qoala-engineering/qoala-common/middleware"
)

func main() {
    // some code

    ....
    // initiate echo framework
    e := echo.New()

    // define the middleware when you define your route
    e.GET("/api/foobar", handler.FooBarHandler, 
        echo.WrapMiddleware(QoalaCommonMiddleware.JWTAuthenticationV1(QoalaCommonMiddleware.Config{JWTKeyEndpoint: "https://api.qoala.app/api/sessions/check"},
    )))
    ....
}
```


### Getting User Data Values from Context

To get the user data values that are passed by context, you can get the values from
the request-scoped context:

```go
          ac := c.(*SharedUtil.CustomApplicationContext)
          ctxUserData, ok := (ac.Request().Context().Value(QoalaCommonMiddleware.ContextUserKey)).(QoalaCommonMiddleware.CheckUserV1Response)
          if !ok {
                  return nil, errors.New("cast error - should never happen unless you use a wrong struct")
          }
          userData := ctxUserData.Data.User
```

```go
          ac := c.(*SharedUtil.CustomApplicationContext)
          ctxUserData, ok := (ac.Request().Context().Value(QoalaCommonMiddleware.ContextUserKey)).(QoalaCommonMiddleware.CheckUserV1Response)
          if !ok {
                  return nil, errors.New("cast error - should never happen unless you use a wrong struct")
          }
          userData := ctxUserData.Data.User
```

Based on the kind of authentication that's used, you will need to cast the user data to it's corresponding response.

AuthMiddleware | Response Struct 
-------------- | -------------------- 
JWT V1         | CheckUserV1Response
JWT V2         | CheckUserV2Response
Key Auth       | PartnerKeyResponse



### Panic Handler or Recover
This middleware is for handling once a panic occurs in our service, it doesn't stop the flow
it still works as well, besides that once a panic occurs we can send some metrics to our datadog as well
can send notifications to our slack channel, so our engineers can be aware of some of the processes in our endpoints that are affected by the error panic

example usage for endpoint middleware:
```go
slackClient := qoalaSlack.NewWebhookNotification(conf.WebhookURL)
ddClient, err := QoalaDatadog.NewDatadogClient(QoalaDatadog.Config{
		Namespace: conf.ServiceName,
		Env:       conf.DatadogEnv,
		Unit:      conf.DatadogUnit,
		Host:      conf.DatadogHost,
})

customMiddleware := qoalaMiddleware.PanicHandlerOption(middleware.PanicHandlerOption{
	AlertOptions: []qoalaMiddleware.Option{
		{
			NotificationType:  middleware.DATADOG, 
			DataDogOption: qoalaMiddleware.DataDogOption{
				Name:   "datadog-name", 
				Tag:    "datadog-tag", 
				Client: ddClient,
			},
		},
		{
			NotificationType:  middleware.SLACK, 
			SlackOption: qoalaMiddleware.SlackOption{
				SlackClient: slackClient,
			},
		},
	},
})

e.Use(echo.WrapMiddleware(customMiddleware))
```
example usage for goroutine:
```go
// declare your option 
option := qoalaMiddleware.PanicHandlerOption(middleware.PanicHandlerOption{
	AlertOptions: []qoalaMiddleware.Option{
		{
			NotificationType:  middleware.DATADOG, 
			DataDogOption: qoalaMiddleware.DataDogOption{
				Name:   "datadog-name", 
				Tag:    "datadog-tag", 
				Client: ddClient,
			},
		},
		{
			NotificationType:  middleware.SLACK, 
			SlackOption: qoalaMiddleware.SlackOption{
				SlackClient: slackClient,
			},
		},
	},
	EventName: "bulk-update",
})

go func() {
    defer middleware.GoRoutinePanicHandler(option)
    panic("some event unhandled properly")
}()
```

example:
- run the unit test
- go the #alarms-payment-service-testing
- find the result
slack-result:
    - <img width="675" alt="Screen Shot 2023-01-05 at 07 55 11" src="https://user-images.githubusercontent.com/29673571/210677706-c888f265-db17-4161-adcc-94b333a6bbaf.png">

    - <img width="559" alt="Screen Shot 2023-01-05 at 11 06 49" src="https://user-images.githubusercontent.com/29673571/210699754-190977d3-24d3-4283-ac8f-680ddb9fe4cb.png">
